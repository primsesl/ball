<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Баллы</title>
<script src="js/jquery.js"></script>
<script src="js/jquery-ui.js"></script>
<script src="js/jquery.ui.datepicker-ru.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<link href="js/jquery-ui.css" rel="stylesheet">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/bootstrap-theme.min.css" rel="stylesheet">
</head>

<body>
<!--Навигация-->
	<nav class="navbar navbar-inverse navbar-fixed-top">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#example-navbar-collapse">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="#">v 1.3 Учет баллов</a>
			<p id="total_s" class="navbar-text">Signed in as <a href="#" class="navbar-link">Mark Otto</a></p>
		</div>
   <div class="collapse navbar-collapse" id="example-navbar-collapse">
      <ul class="nav navbar-nav">
         <li><a href="#">Настройки</a></li>
      </ul>
   </div>	</div>
	</nav>	
<!--Конец Навигация-->

<!--Вверх-->
    <div class="page-header">
    </div>
<!--Конец Вверх-->

<!--Контент-->
    <div class="container theme-showcase" role="main">
		<button id="add_work" type="button" class="btn btn-primary">Добавить</button>
			<table id="work" class="table table-bordered">
				<thead>
					<tr>
						<th width="100px">Дата</th>
						<th width="50px">Л.С</th>
						<th>Вид работ</th>
						<th width="30px">Балы</th>
						<th width="50px">Кнопки</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
			<div class="modal fade" id="Modal_add_work" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
			  <div class="modal-dialog">
				<div class="modal-content">
				  <div class="modal-header">
					<button type="button" class="close add_work_close" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel1">Добавить вид работ</h4>
				  </div>
				  <div class="modal-body">
					<div class="form-group col-xs-6">
						<label for="work_date">Дата</label>
						<input type="date" class="form-control" id="work_date" placeholder="Описание">
					</div>
					<div class="form-group col-xs-6">
					<label for="work_ls">Л.С</label>
					<input type="number" class="form-control" id="work_ls" placeholder="Л.С">
					</div>
						<div class="col-xs-3" for="work_vid">Вид работ</div>
					<div class="row">
						<div class="form-group col-xs-10">
							<select id="add_sel" class="form-control">
						
							</select>
						</div>
						<div class=" col-xs-2">
							<button id="add_ball_for_ls" type="button" class="btn btn-primary">+</button>
						</div>
					</div>
					<div class="row">
						<div class="col-xs-12">
							<table id="scores_for_add" class="table">
								<thead>
									<tr>
										<th>Вид робот</th>
										<th width="30px">Баллы</th>
									</tr>
								</thead>
								<tfoot>
									<tr>
										<th>Итого</th>
										<th id="summ"></th>
									</tr>
								</tfoot>
								<tbody>
								</tbody>
								
							</table>
						</div>
					</div>
				  <div class="modal-footer">
					<button id="add_save_work" type="button" class="btn btn-primary">Сохранить1</button>
					<button id="" type="button" class="btn btn-default add_work_close">Закрыть</button>
				  </div>
				</div>
			  </div>
			</div>
		</div>
	</div>
<!--Конец Контент-->

<!--Настройки-->
<div class="modal fade" id="Modal_ball" tabindex="-1" role="dialog" aria-labelledby="ballModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="ballModalLabel">Редактирование вид работ</h4>
      </div>
      <div class="modal-body">
	  			<button type="button" id="buttonqqq" class="btn btn-default btn-xs">Развернуть форму</button>
		<div id="div_add_ball">
			<div class="form-group">
				<label for="desc">Описание</label>
				<input type="text" class="form-control" id="desc" placeholder="Описание">
			</div>
			<div class="form-group">
				<label for="ball">Баллы</label>
				<input type="number" class="form-control" id="ball" placeholder="Баллы">
			</div>
			<button type="button" id="add" class="btn btn-default navbar-btn" data-toggle="modal">Дабавить</button>
		</div>
		<div id="div_edit_ball">
			<div id="edit_id"></div>
			<div class="form-group">
				<label for="edit_desc">Описание</label>
				<input type="text" class="form-control" id="edit_desc" placeholder="Описание">
			</div>
			<div class="form-group">
				<label for="edit_ball">Баллы</label>
				<input type="number" class="form-control" id="edit_ball" placeholder="Баллы">
			</div>
			<button id="edit_save_ball" type="button" class="btn btn-primary">Сохранить</button>
		</div>
			  <!-- Table -->
			<table id="scores" class="table">
				<thead>
					<tr>
						<th>Описание</th>
						<th width="30px">Баллы</th>
						<th width="50px">Кнопки</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
			<div class="modal fade" id="Modal_add" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			  <div class="modal-dialog">
				<div class="modal-content">
				  <div class="modal-header">
					<button type="button" class="close add_close" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel">Добавить вид работ</h4>
				  </div>
				  <div class="modal-body">
				  </div>
				  <div class="modal-footer">
					<button id="add" type="button" class="btn btn-primary">Сохранить</button>
					<button id="" type="button" class="btn btn-default add_close">Закрыть</button>
				  </div>
				</div>
			  </div>
			</div>
			<div class="modal fade" id="Modal_edit" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
			  <div class="modal-dialog">
				<div class="modal-content">
				  <div class="modal-header">
					<button type="button" class="close edit_ball_close" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="editModalLabel">Редактирование вид работ</h4>
				  </div>
				  <div class="modal-body">
				  <div id="edit_id"></div>
					<div class="form-group">
					<label for="edit_desc">Описание</label>
					<input type="text" class="form-control" id="edit_desc" placeholder="Описание">
					</div>
					<div class="form-group">
					<label for="edit_ball">Баллы</label>
					<input type="number" class="form-control" id="edit_ball" placeholder="Баллы">
					</div>
				  </div>
				  <div class="modal-footer">
					<button type="button" class="edit_ball_close btn btn-default">Закрыть</button>
				  </div>
				</div>
			  </div>
			</div>	
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>
<!--Конец Настройки-->	

	<script type="text/javascript">
	$(function() {
	
//База данных
	var db_name = "events_cal";
	var db_version = "1.0";
    var db_description = "подсчет баллов";
		
	//var spec = []
	var speckyboy = {}
		speckyboy.init = {}
		speckyboy.init.db = {}
		
	speckyboy.init.open = function(){
		speckyboy.init.db = openDatabase(db_name,db_version,db_description,1024*1024*5);
		// название БД, версия, описание, размер
	}
	speckyboy.init.createTable = function(){
		 var database = speckyboy.init.db;
		 database.transaction(function(tx){
			tx.executeSql("CREATE TABLE IF NOT EXISTS balls (id INTEGER PRIMARY KEY ASC, desc VARCHAR, ball INT)", []);
			tx.executeSql("CREATE TABLE IF NOT EXISTS work (id INTEGER PRIMARY KEY ASC, date VARCHAR, ls VARCHAR, desc VARCHAR, ball INT)", []);
		 });
	}
	
	// получение данных из БД
	speckyboy.init.addBall = function(desc,ball){
		var database = speckyboy.init.db;
		database.transaction(function(tx){
			 tx.executeSql("INSERT INTO balls (desc, ball) VALUES (?,?)", [desc,ball],
			 speckyboy.init.getBall());
		});
	}
	speckyboy.init.addWork = function(date, ls, desc, count){
		var database = speckyboy.init.db;
		database.transaction(function(tx){
			 tx.executeSql("INSERT INTO work (date, ls, desc, ball) VALUES (?,?,?,?)", [date, ls, desc, count],
			 speckyboy.init.getBall());
		});
	}
	speckyboy.init.getBall = function(){
		var database = speckyboy.init.db;
			$table = $("#scores tbody");
			$table.html('');
			database.transaction(function(tx){
				tx.executeSql("SELECT * FROM balls ORDER BY desc ASC", [], function(tx,result){
					for (var i=0; i < result.rows.length; i++) {
						todo_id = result.rows.item(i).id;
						todo_desc = result.rows.item(i).desc;
						todo_ball = result.rows.item(i).ball;
						$table.append(
							'<tr id="row_ball_'+todo_id+'" data-id="'+todo_id+'">'+
								'<td id="td_ball_desc_'+todo_id+'">'+ todo_desc+'</td>'+
								'<td id="td_ball_ball_'+todo_id+'">'+ todo_ball+'</td>'+
								'<td>'+
								'<button type="button" class="del_ball btn btn-default btn-xs"><span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span></button>'+
								'<button type="button" class="edit btn btn-default btn-xs"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></button></td>'+
							'</tr>');

					}
				});
			});
		setTimeout(function(){
			deleteClickOn();
			editClickOn();
		}, 200);
	}
	speckyboy.init.getWork = function(){
		var database = speckyboy.init.db;
			$table1 = $("#work tbody");
			$table1.html('');
			database.transaction(function(tx){
				tx.executeSql("SELECT * FROM work ORDER BY date ASC", [], function(tx,result){
					total_work = 0;
					for (var il=0; il < result.rows.length; il++) {
						todo_id = result.rows.item(il).id;
						todo_date = result.rows.item(il).date;
						todo_ls = result.rows.item(il).ls;
						//todo_desc = result.rows.item(il).desc;
						todo_desc = show_desc(result.rows.item(il).desc);
						todo_ball = (result.rows.item(il).ball == null) ? 0 : result.rows.item(il).ball;
						total_work = total_work + parseFloat(todo_ball);
						$table1.append(
							'<tr id="row_'+todo_id+'" data-id="'+todo_id+'">'+
								'<td id="td_desc_'+todo_id+'">'+ todo_date+'</td>'+
								'<td>'+ todo_ls+'</td>'+
								'<td>'+ todo_desc+'</td>'+
								'<td>'+ todo_ball+'</td>'+
								'<td>'+
								'<button type="button" class="del btn btn-default btn-xs"><span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span></button>'+
								'</td>'+
							'</tr>');

					}
					$('#total_s').html(total_work.toFixed(2));
				});
			});
		setTimeout(function(){
			deleteClickWorkOn();
		}, 200);
	}
	speckyboy.init.getBall_for_work = function(){
		$("#add_sel").html('');
		var database = speckyboy.init.db;
			database.transaction(function(tx){
				tx.executeSql("SELECT * FROM balls ORDER BY desc ASC", [], function(tx,result){
					for (var i=0; i < result.rows.length; i++) {
						todo_id = result.rows.item(i).id;
						todo_desc = result.rows.item(i).desc;
						todo_ball = result.rows.item(i).ball;
						$("#add_sel").append(
								'<option data-id="'+todo_id+'" data-ball="'+todo_ball+'">'+ todo_desc+'</option>');

					}
				});
			});
		setTimeout(function(){
			deleteClickOn();
			editClickOn();
		}, 200);
	}
	speckyboy.init.editRowBall = function(id){
		var database = speckyboy.init.db;
		database.transaction(function(tx){
			tx.executeSql("SELECT * FROM balls WHERE id=?", [id], function(tx,result){
				for (var i=0; i < result.rows.length; i++) {
					todo_id = result.rows.item(i).id;
					todo_desc = result.rows.item(i).desc;
					todo_ball = result.rows.item(i).ball;
						$('#edit_desc').val(todo_desc);
						$('#edit_ball').val(todo_ball);
						$('#edit_id').html(todo_id);
				}
			});
		});
	}
	speckyboy.init.editSaveBall = function(id, desc, ball){
		//alert(id);
		var database = speckyboy.init.db;
		database.transaction(function(tx){
			tx.executeSql('UPDATE balls SET desc = ?, ball = ? WHERE id = ?', [desc, ball, id]);
		});
	}
	speckyboy.init.deleteRow = function(id, table){
		var database = speckyboy.init.db;
		database.transaction(function(tx){
			tx.executeSql("DELETE FROM "+table+" WHERE id=?",[id]);
		});
	}
//Конец База данных

	$( "#div_edit_ball" ).hide();
	$( "#div_add_ball" ).hide();

    $("#buttonqqq").click(function() {
		if($( "#div_edit_ball" ).css('display') == 'block'){
			$( "#div_edit_ball" ).hide('blind', {}, 500, '' );
		}
		if($( "#div_add_ball" ).css('display') == 'block'){
			$( "#div_add_ball" ).hide('blind', {}, 500, '' );
			$("#buttonqqq").html('Развернуть форму')
		}else{
			$("#buttonqqq").html('Свернуть форму')
			$( "#div_add_ball" ).show('blind', {}, 500, '' );
		}
    });
    function editClickOn() {
			$(".edit")
				.click(function() {
					var $thisTr = $(this).parent().parent(),
						timeID = $thisTr.data("id"),
						oldid = parseFloat($('#edit_id').html());
						//alert(timeID);
						speckyboy.init.editRowBall(timeID);
						if($( "#div_add_ball" ).css('display') == 'block'){
							$( "#div_add_ball" ).hide('blind', {}, 500, '' );
						}
						if (timeID == oldid){
							if($( "#div_edit_ball" ).css('display') == 'block'){
								$("#div_edit_ball").hide('blind', {}, 500, '' );
							}else{
								$("#div_edit_ball").show('blind', {}, 500, '' );
								//$("#div_edit_ball").toggle('blind', {}, 500 );
							}
							
						}else{
							if($( "#div_edit_ball" ).css('display') == 'block'){
							}else{
								$("#div_edit_ball").show('blind', {}, 500, '' );
								//$("#div_edit_ball").toggle('blind', {}, 500 );
							}
						}
        });
    }
	

	$('.navbar-collapse').click('li', function() {
		$('.navbar-collapse').collapse('hide');
		$('#Modal_ball').modal('show'); 
	});
	$( ".add_close" ).click(function() {
		$('#Modal_add').modal('hide'); 
	});
	$( "#edit_save_ball" ).click(function() {
		id = $('#edit_id').html();
		desc = $('#edit_desc').val();
		ball = $('#edit_ball').val();
		speckyboy.init.editSaveBall(id, desc, ball);
		$("#td_ball_desc_"+id).html(desc);
		$("#td_ball_ball_"+id).html(ball);
		$("#div_edit_ball").toggle('blind', {}, 500 );
		//$('#Modal_edit').modal('hide'); 
	});
	$(".edit_ball_close").click(function() {
		$('#Modal_edit').modal('hide'); 
	});
	$("#add").click(function() {
		var val1 = $("#desc").val();
		var val2 = $("#ball").val();
		speckyboy.init.addBall(val1,val2);
		$('#Modal_add').modal('hide');
		$("#desc").val('');
		$("#ball").val('');
	});
	$("#add_ball_for_ls").click(function() {
		$add_sel = $("#add_sel").find(':selected');
		$add_sel_id 	= $add_sel.data('id');
		$add_sel_ball 	= $add_sel.data('ball');
		$add_sel_text 	= $add_sel.text();
		
		$("#scores_for_add").append(
			'<tr data-id="'+$add_sel_id+'">'+
				'<td>'+ $add_sel_text+'</td>'+
				'<td>'+ $add_sel_ball+'</td>'+
			'</tr>');
			
		change_add();
		//lert($add_sel_text);
	});
	$( ".add_work_close" ).click(function() {
		$('#Modal_add_work').modal('hide');
	});
	$( "#add_work" ).click(function() {
		speckyboy.init.getBall_for_work();
		$('#Modal_add_work').modal('show');
	});
	$( "#add_save_work" ).click(function() {
		var work_desc_arr = [];
		var work_desc_arr_all 	= [],
			count 				= 0;
		$("#scores_for_add tbody tr").each(function () {
			work_desc_arr 		= {};
			work_desc_arr.desc = $(this).find("td:nth-child(1)").text();
			work_desc_arr.ball = $(this).find("td:nth-child(2)").text();
			work_desc_arr_all.push(work_desc_arr);
			count = count + parseFloat($(this).find("td:nth-child(2)").text());
		});
		date = $('#work_date').val();
		desc = JSON.stringify(work_desc_arr_all);
		ls = $('#work_ls').val();
		//ball = $('#edit_ball').val();
		speckyboy.init.addWork(date, ls, desc, count);
		$('#Modal_add_work').modal('hide');
		$('#work_ls').val('');
		$('#work_date').val('');
		$('#summ').html('');
		$("#scores_for_add tbody").html('');
		speckyboy.init.getWork();
	});
	function show_desc(desc){
		var desc_arr = $.parseJSON(desc);
		if(!desc_arr){
			res = '';
		}else{
			res = '';
			var zp = ', '
			for (var di=0; di < desc_arr.length; di++) {
				if(di+1 === desc_arr.length){
					zp = '';
				}
				res = res + ''+desc_arr[di].desc+' <span class="label label-success">'+desc_arr[di].ball+'</span>'+zp;
				console.log(desc_arr[di].desc);
			}
		}
	return res;
	}
    function change_add() {
		var work_desc_arr_all 	= [],
			work_desc_arr 		= {},
			count 				= 0;
		$("#scores_for_add tbody tr").each(function () {
			work_desc_arr.desc = $(this).find("td:nth-child(1)").text();
			work_desc_arr.ball = $(this).find("td:nth-child(2)").text();
			work_desc_arr_all.push(work_desc_arr);
			count = count + parseFloat($(this).find("td:nth-child(2)").text());
		});
		
		$('#summ').html(count);
		console.log(work_desc_arr_all); 
		
	
	}
    function table() {
		if(localStorage["ball"]){
			item = JSON.parse(localStorage["ball"])
			$table = $("#scores tbody");
			$table.html('');
			  for (var r=0; r<item.length; r++) {
				$table.append(
					'<tr data-id="'+item[r].id+'">'+
						'<td>'+ item[r].desc+'</td>'+
						'<td>'+ item[r].ball+'</td>'+
						'<td>'+
						'<button type="button" class="del_ball btn btn-default btn-xs"><span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span></button>'+
						'<button type="button" class="edit btn btn-default btn-xs"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></button></td>'+
					'</tr>');
				console.log("index"+ r + " - "+ item[r].desc);
			  }
				deleteClickOn();
				editClickOn();
			
		}else{
		}
    }
    function deleteClickWorkOn() {
			$( ".del")
				.click(function() {
            var $thisTr = $(this).parent().parent(),
                timeID = $thisTr.data("id");
				$tttt = $("#row_"+timeID);
				//alert(timeID);
            speckyboy.init.deleteRow(timeID, 'work') 
			speckyboy.init.getWork();
			$tttt.fadeOut()
        })
    }
    function deleteClickOn() {
			$( ".del_ball")
				.click(function() {
            var $thisTr = $(this).parent().parent(),
                timeID = $thisTr.data("id");
				$tttt = $("#row_ball_"+timeID);
				//alert(timeID);
            speckyboy.init.deleteRow(timeID, 'balls') 
			$tttt.fadeOut()
        })
    }
    function deleteItem(timeID) {
        var clbObj = $.parseJSON(localStorage.ball),
            newObj = {},
            newVal = {};
        return newObj = [], $.each(clbObj, function(ind, val) {
            val.id != timeID && (newVal = {}, newVal.id = val.id, newVal.desc = val.desc, newVal.ball = val.ball, newObj.push(newVal))
        }), localStorage.ball = JSON.stringify(newObj), !0
    }

	Array.prototype.uniq = function(){
	  return this.filter(
		function(a){
			return !this[a] ? this[a] = true : false;
		},
		{}
	  );
	}	
	// Функция аналогичная php функции inArray
	inArray = Array.prototype.indexOf ?
		function (arr, val) {
			return arr.indexOf(val) != -1
		}:
		function (arr, val) {
			var i = arr.length
			while (i--) {
				if (arr[i] === val) return true
			}
			return false
		}
	speckyboy.init.open();
	speckyboy.init.createTable();
	speckyboy.init.getWork();
	speckyboy.init.getBall();
	});
	</script>
</body>
</html>
